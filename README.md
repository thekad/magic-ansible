# Magic Ansible

[![License](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](LICENSE)
[![Go Version](https://img.shields.io/badge/Go-1.23+-blue.svg)](https://golang.org/)

Magic Ansible is a code generation tool that automatically creates Ansible modules for Google Cloud Platform (GCP) resources from the [Magic Modules](https://github.com/GoogleCloudPlatform/magic-modules) project. It transforms GCP resource definitions into fully functional Ansible modules with proper documentation, examples, and type safety.

## Features

- ðŸš€ **Automated Code Generation**: Generate Ansible modules from Magic Modules YAML definitions
- ðŸ“š **Complete Documentation**: Auto-generate module documentation following Ansible standards
- ðŸ”§ **Template-Based**: Customizable templates for module generation
- ðŸŽ¯ **Selective Generation**: Generate specific products or resources
- ðŸ”„ **Override Support**: Customize generated modules with YAML overrides
- ðŸ§ª **Test Generation**: Generate integration tests for modules

## Installation

### Prerequisites

- Go 1.23 or later
- Git

### Get the Source

```bash
git clone https://github.com/thekad/magic-ansible.git
cd magic-ansible
go build .
```

## Usage

### Basic Usage

NOTE: you could use the binary created by `go build` but all examples show how to do this with `go run`

Generate all available modules:

```bash
go run .
```

### Command Line Options

| Flag | Default | Description |
|------|---------|-------------|
| `-git-url` | `https://github.com/GoogleCloudPlatform/magic-modules` | Git repository to clone |
| `-git-dir` | `magic-modules` | Path to clone magic modules repo |
| `-git-rev` | `main` | Git revision to checkout |
| `-git-pull` | `false` | Git pull before checkout |
| `-output` | `output` | Path to write autogenerated files |
| `-overrides` | `overrides` | Path to override files |
| `-templates` | `templates` | Path to template files |
| `-products` | | Comma-separated list of products to generate |
| `-resources` | | Comma-separated list of resources to generate |
| `-no-code` | `false` | Skip code generation |
| `-no-tests` | `false` | Skip test generation |
| `-overwrite` | `false` | Overwrite existing files |

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `LOG_LEVEL` | `info` | Logging level (trace, debug, info, warn, error, fatal) |

## Examples

### Generate Specific Products

Generate modules for Cloud Build and Compute products:

```bash
go run . -products cloudbuildv2,compute
```

### Generate Specific Resources

Generate only specific resources from Cloud Build:

```bash
go run . -products cloudbuildv2 -resources connection,repository
```

### Custom Output Directory

Generate modules to a custom directory:

```bash
go run . -output ./my-ansible-modules
```

### Enable Debug Logging

```bash
LOG_LEVEL=debug go run . -products cloudbuildv2
```

### Overwrite Existing Files

```bash
go run . -products cloudbuildv2 -overwrite
```

### Use Custom Templates

```bash
go run . -templates ./my-templates -products cloudbuildv2
```

## Overrides

Override files allow customization of generated modules using YAML. They support:

### Example Override

```yaml
---
# Remove unwanted examples
examples:
  - name: "unwanted_example"
    _drop: true

# Update parameter documentation
parameters:
  - name: 'parent_connection'
    type: ResourceRef
    description: |
      Custom description for the connection parameter.
```

### Override Features

- **Drop Items**: Use `_drop: true` to remove items from lists of maps
- **Merge Dictionaries**: Override specific fields in nested objects
- **Smart Matching**: Automatically matches items by `name` or `id` fields
- **Replace Lists**: Lists of scalars are completely replaced with the override

## Development

### Running

```bash
go run .
```

### Building (Optional)

```bash
go build -o magic-ansible .
```

## License

This project is licensed under the Apache License 2.0 - see the [LICENSE](LICENSE) file for details.

## Acknowledgments

- [Magic Modules](https://github.com/GoogleCloudPlatform/magic-modules) - Source of GCP resource definitions
- [Ansible](https://github.com/ansible/ansible) - Target platform for generated modules
- [Red Hat](https://www.redhat.com/) - Project sponsor and maintainer
