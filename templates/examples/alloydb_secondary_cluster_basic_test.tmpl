- name: Test case
  block:
    - name: Create primary alloydb cluster
      google.cloud.gcp_alloydb_cluster:
        cluster_id: "{{`{{ resource_name }}`}}-primary"
        state: present
        location: us-central1
        cluster_type: PRIMARY
        network_config:
          network: "projects/{{`{{ gcp_project_id }}`}}/global/networks/{{`{{ resource_name }}`}}"
        project: "{{`{{ gcp_project }}`}}"
        auth_kind: "{{`{{ gcp_cred_kind }}`}}"
        service_account_file: "{{`{{ gcp_cred_file }}`}}"
      register: _primary

    - name: Run assertions
      ansible.builtin.assert:
        that:
          - _primary.changed == true
          - _primary.displayName is not defined

    - name: Update primary alloydb cluster display name
      google.cloud.gcp_alloydb_cluster:
        cluster_id: "{{`{{ resource_name }}`}}-primary"
        state: present
        location: us-central1
        cluster_type: PRIMARY
        display_name: Test cluster
        network_config:
          network: "projects/{{`{{ gcp_project_id }}`}}/global/networks/{{`{{ resource_name }}`}}"
        project: "{{`{{ gcp_project }}`}}"
        auth_kind: "{{`{{ gcp_cred_kind }}`}}"
        service_account_file: "{{`{{ gcp_cred_file }}`}}"
      register: _primary

    - name: Create secondary cluster attached to primary
      google.cloud.gcp_alloydb_cluster:
        cluster_id: "{{`{{ resource_name }}`}}-secondary"
        state: present
        location: us-central1
        cluster_type: SECONDARY
        network_config:
          network: "projects/{{`{{ gcp_project_id }}`}}/global/networks/{{`{{ resource_name }}`}}"
        secondary_config:
          primary_cluster_name: "{{`{{ _primary.name }}`}}"
        project: "{{`{{ gcp_project }}`}}"
        auth_kind: "{{`{{ gcp_cred_kind }}`}}"
        service_account_file: "{{`{{ gcp_cred_file }}`}}"
      register: _secondary

    - name: Run assertions
      ansible.builtin.assert:
        that:
          - _primary.changed == true
          - _primary.clusterType == "PRIMARY"
          - _secondary.changed == true
          - _secondary.clusterType == "SECONDARY"

  always:
    - name: Delete secondary cluster
      google.cloud.gcp_alloydb_cluster:
        cluster_id: "{{`{{ resource_name }}`}}-secondary"
        state: absent
        location: us-central1
        project: "{{`{{ gcp_project }}`}}"
        auth_kind: "{{`{{ gcp_cred_kind }}`}}"
        service_account_file: "{{`{{ gcp_cred_file }}`}}"

    - name: Delete primary cluster
      google.cloud.gcp_alloydb_cluster:
        cluster_id: "{{`{{ resource_name }}`}}-primary"
        state: absent
        location: us-central1
        project: "{{`{{ gcp_project }}`}}"
        auth_kind: "{{`{{ gcp_cred_kind }}`}}"
        service_account_file: "{{`{{ gcp_cred_file }}`}}"
